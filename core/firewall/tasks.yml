# -*- mode: yaml -*-
- name: Lock down the server's firewall with UFW
  when: gb_lockdown_firewall
  block:
    - name: Ensure we have UFW installed for firewall
      apt:
        name: ufw
        state: present

    - name: Disable UFW and set default policy to deny
      community.general.ufw:
        state: disabled
        default: deny

    # NOTE: ports added by modules are dynamically added to loop
    - name: Allow connections to default & configured ports from LAN
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        from: "{{ gb_local_subnet }}"
      loop:
        - 22
        - 80

    # NOTE: ports added by modules are dynamically added to loop
    - name: Allow connections to default & configured ports from WAN
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        from: "{{ gb_local_subnet }}"
      loop:
        - 443

    - name: Enable UFW
      community.general.ufw:
        state: enabled
