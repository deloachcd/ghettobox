compose:
  restic-backup:
    image: mazzolino/restic
    environment:
      RUN_ON_STARTUP: "true"
      BACKUP_CRON: "{{ restic_backup_schedule }}"
      RESTIC_PASSWORD: ghettobox
      RESTIC_REPOSITORY: /mnt/restic
      RESTIC_BACKUP_SOURCES: /data
      RESTIC_BACKUP_ARGS: >-
        --tag docker-volumes
        --verbose
      RESTIC_FORGET_ARGS: "--keep-last {{ restic_keep_last }}"
      TZ: "{{ local_timezone }}"
    volumes:
      - "{{ restic_backup_src }}:/data:ro"
      - "{{ restic_backup_path }}:/mnt/restic"

  restic-prune:
    image: mazzolino/restic
    environment:
      RUN_ON_STARTUP: "true"
      PRUNE_CRON: "{{ restic_prune_schedule }}"
      RESTIC_REPOSITORY: /mnt/restic
      RESTIC_PASSWORD: ghettobox
      TZ: "{{ local_timezone }}"

tasks:
  - name: Ensure restic_backup_path exists, and is owned by gb_user
    file:
      path: "{{ restic_backup_path }}"
      state: directory
      owner: "{{ gb_user }}"
    become: yes
